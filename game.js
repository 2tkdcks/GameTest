console.log("game.js Ïä§ÌÅ¨Î¶ΩÌä∏ ÏãúÏûëÎê®"); // Ïä§ÌÅ¨Î¶ΩÌä∏ ÌååÏùº Ïã§Ìñâ Ïó¨Î∂Ä ÌôïÏù∏Ïö© ÏµúÏÉÅÎã® Î°úÍ∑∏

const canvas = document.getElementById('gameCanvas');
// canvas ÏöîÏÜåÍ∞Ä Ï†úÎåÄÎ°ú Î°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏
if (!canvas) {
    console.error("Ï∫îÎ≤ÑÏä§ ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§! HTMLÏóê 'gameCanvas' IDÎ•º Í∞ÄÏßÑ canvas ÌÉúÍ∑∏Í∞Ä ÏûàÎäîÏßÄ, Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä DOM Î°úÎìú ÌõÑ Ïã§ÌñâÎêòÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
} else {
    console.log("Ï∫îÎ≤ÑÏä§ ÏöîÏÜå Í∞ÄÏ†∏Ïò§Í∏∞ ÏÑ±Í≥µ:", canvas);
}

const ctx = canvas ? canvas.getContext('2d') : null;
if (!ctx) {
    console.error("2D Ïª®ÌÖçÏä§Ìä∏Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§! canvas ÏöîÏÜåÍ∞Ä Ïú†Ìö®ÌïúÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
} else {
    console.log("2D Ïª®ÌÖçÏä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞ ÏÑ±Í≥µ");
}


// Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏÑ§Ï†ï (ctxÍ∞Ä Ïú†Ìö®Ìï† ÎïåÎßå Ïã§Ìñâ)
if (ctx) {
    canvas.width = 800;
    canvas.height = 500;
    console.log("Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏÑ§Ï†ï ÏôÑÎ£å:", canvas.width, "x", canvas.height);
}


// --- Í≤åÏûÑ ÏöîÏÜå Í∞ùÏ≤¥ Î∞è Î∞∞Ïó¥ ---

// ÌîåÎ†àÏù¥Ïñ¥ ÏÑ§Ï†ï
const player = {
    x: 100,
    y: ctx ? canvas.height - 70 : 430, // ctxÍ∞Ä ÏóÜÏùÑ Í≤ΩÏö∞ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö© (Ïò§Î•ò Î∞©ÏßÄÏö©)
    width: 30,
    height: 50,
    color: '#4A90E2',
    speed: 4,
    dx: 0,
    dy: 0,
    jumpStrength: 11,
    gravity: 0.45,
    isGrounded: false,
    facingDirection: 'right',
    attackCooldown: 400,
    lastAttackTime: 0,
    health: 3,
    maxHealth: 3,
    isInvincible: false,
    invincibilityDuration: 1500,
    lastHitTime: 0
};
// ÌîåÎ†àÏù¥Ïñ¥ Í∞ùÏ≤¥Í∞Ä Ïò¨Î∞îÎ•¥Í≤å ÏÉùÏÑ±ÎêòÏóàÎäîÏßÄ ÌôïÏù∏ÌïòÍ∏∞ ÏúÑÌï¥ JSON.stringifyÏôÄ JSON.parseÎ•º ÏÇ¨Ïö© (Í∞ùÏ≤¥ ÎÇ¥Î∂Ä Í∞íÍπåÏßÄ ÌôïÏù∏)
console.log("ÌîåÎ†àÏù¥Ïñ¥ Í∞ùÏ≤¥ Ï¥àÍ∏∞Ìôî ÏãúÎèÑ ÏßÅÌõÑ:", JSON.parse(JSON.stringify(player)));

// Î∞úÏÇ¨Ï≤¥ ÏÑ§Ï†ï
const projectiles = [];
const projectileRadius = 6;
const projectileSpeed = 8;
const projectileColor = '#F5A623';

// ÌîåÎû´Ìèº ÏÑ§Ï†ï
const platforms = [
    { x: 0, y: ctx ? canvas.height - 40 : 460, width: ctx ? canvas.width : 800, height: 40, color: '#6B8E23' },
    { x: 150, y: ctx ? canvas.height - 120 : 380, width: 180, height: 20, color: '#8B4513' },
    { x: 400, y: ctx ? canvas.height - 200 : 300, width: 150, height: 20, color: '#8B4513' },
    { x: 50, y: ctx ? canvas.height - 300 : 200, width: 120, height: 20, color: '#8B4513' },
    { x: 600, y: ctx ? canvas.height - 350 : 150, width: 100, height: 20, color: '#8B4513' }
];
console.log("ÌîåÎû´Ìèº Í∞úÏàò:", platforms.length, "Ï≤´ ÌîåÎû´Ìèº y:", platforms[0].y);

// Ï†Å ÏÑ§Ï†ï
const enemies = [
    // Ï†Å y ÏúÑÏπòÎäî ÌîåÎû´Ìèº Í∏∞Ï§ÄÏúºÎ°ú ÏÑ§Ï†ïÎêòÎØÄÎ°ú, platforms Î∞∞Ïó¥ Ï¥àÍ∏∞Ìôî Ïù¥ÌõÑÏóê yÍ∞í Ìï†Îãπ
];
let score = 0;

const keys = {
    ArrowLeft: false,
    ArrowRight: false,
    Space: false,
    KeyA: false
};

// --- Í∑∏Î¶¨Í∏∞ Ìï®ÏàòÎì§ --- (ctxÍ∞Ä Ïú†Ìö®Ìï† ÎïåÎßå ÏùòÎØ∏ ÏûàÏùå)

function drawPlayer() {
    if (!ctx) return;
    if (player.isInvincible && Math.floor((Date.now() - player.lastHitTime) / 100) % 2 === 0) {
        return;
    }
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.width, player.height);

    ctx.fillStyle = 'white';
    const eyeXOffset = player.facingDirection === 'right' ? player.width * 0.65 : player.width * 0.15;
    ctx.fillRect(player.x + eyeXOffset, player.y + player.height * 0.2, 6, 6);
}

function drawPlatforms() {
    if (!ctx) return;
    platforms.forEach(platform => {
        ctx.fillStyle = platform.color;
        ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
    });
}

function drawProjectiles() {
    if (!ctx) return;
    projectiles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.fill();
        ctx.closePath();
    });
}

function drawEnemies() {
    if (!ctx) return;
    enemies.forEach(enemy => {
        if (enemy.alive) {
            ctx.fillStyle = enemy.color;
            ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
        }
    });
}

function drawUI() {
    if (!ctx) return;
    ctx.fillStyle = 'white';
    ctx.font = '20px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`Ï†êÏàò: ${score}`, 20, 30);

    ctx.textAlign = 'right';
    let healthDisplay = "Ï≤¥Î†•: ";
    for(let i=0; i < player.maxHealth; i++) {
        healthDisplay += (i < player.health) ? "‚ù§Ô∏è" : "üñ§";
    }
    ctx.fillText(healthDisplay, canvas.width - 20, 30);

    if (player.health <= 0) {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.font = '40px Arial';
        ctx.fillStyle = 'red';
        ctx.textAlign = 'center';
        ctx.fillText('Í≤åÏûÑ Ïò§Î≤Ñ', canvas.width / 2, canvas.height / 2 - 20);
        ctx.font = '20px Arial';
        ctx.fillStyle = 'white';
        ctx.fillText('Îã§Ïãú ÏãúÏûëÌïòÎ†§Î©¥ R ÌÇ§Î•º ÎàÑÎ•¥ÏÑ∏Ïöî', canvas.width / 2, canvas.height / 2 + 20);
    }
}

function clearCanvas() {
    if (!ctx) return;
    ctx.fillStyle = '#555';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}

// --- ÏóÖÎç∞Ïù¥Ìä∏ Ìï®ÏàòÎì§ (Í≤åÏûÑ Î°úÏßÅ) ---

function updatePlayer() {
    if (!ctx || (player.health <= 0 && !gameRunning)) return;

    if (keys.ArrowLeft) {
        player.x -= player.speed;
        player.facingDirection = 'left';
    }
    if (keys.ArrowRight) {
        player.x += player.speed;
        player.facingDirection = 'right';
    }

    if (keys.Space && player.isGrounded) {
        player.dy = -player.jumpStrength;
        player.isGrounded = false;
    }

    player.dy += player.gravity;
    player.y += player.dy;
    player.isGrounded = false;

    platforms.forEach(platform => {
        if (player.x < platform.x + platform.width &&
            player.x + player.width > platform.x &&
            player.y + player.height >= platform.y &&
            player.y + player.height - player.dy <= platform.y + 1 &&
            player.dy >= 0) {
            player.y = platform.y - player.height;
            player.dy = 0;
            player.isGrounded = true;
        }
        if (player.x < platform.x + platform.width &&
            player.x + player.width > platform.x &&
            player.y <= platform.y + platform.height &&
            player.y - player.dy >= platform.y + platform.height -1 &&
            player.dy < 0) {
            player.y = platform.y + platform.height;
            player.dy = 0.1;
        }
    });

    if (player.x < 0) player.x = 0;
    if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

    if (player.y + player.height > canvas.height && !player.isGrounded) {
        player.health -=1;
        console.log("ÌîåÎ†àÏù¥Ïñ¥ Ï∂îÎùΩ! ÌòÑÏû¨ Ï≤¥Î†•:", player.health);
        if(player.health > 0) {
            player.x = 100;
            player.y = canvas.height - 70;
            player.dy = 0;
            player.isGrounded = true;
            player.isInvincible = true;
            player.lastHitTime = Date.now();
        }
    }

    const now = Date.now();
    if (keys.KeyA && (now - player.lastAttackTime > player.attackCooldown)) {
        const projectile = {
            x: player.facingDirection === 'right' ? player.x + player.width + projectileRadius : player.x - projectileRadius,
            y: player.y + player.height / 2,
            radius: projectileRadius,
            color: projectileColor,
            dx: player.facingDirection === 'right' ? projectileSpeed : -projectileSpeed
        };
        projectiles.push(projectile);
        player.lastAttackTime = now;
    }

    if (player.isInvincible && (Date.now() - player.lastHitTime > player.invincibilityDuration)) {
        player.isInvincible = false;
    }
}

function updateProjectiles() {
    if (!ctx) return;
    for (let i = projectiles.length - 1; i >= 0; i--) {
        const p = projectiles[i];
        p.x += p.dx;
        if (p.x - p.radius > canvas.width || p.x + p.radius < 0) {
            projectiles.splice(i, 1);
        }
    }
}

function updateEnemies() {
    if (!ctx) return;
    enemies.forEach(enemy => {
        if (enemy.alive && enemy.speed > 0) {
            enemy.x += enemy.speed * enemy.direction;
            if (enemy.x < enemy.originalX - enemy.patrolRange || enemy.x + enemy.width > enemy.originalX + enemy.patrolRange + enemy.width) {
                 enemy.direction *= -1;
                 if(enemy.x < enemy.originalX - enemy.patrolRange) enemy.x = enemy.originalX - enemy.patrolRange;
                 if(enemy.x + enemy.width > enemy.originalX + enemy.patrolRange + enemy.width) enemy.x = enemy.originalX + enemy.patrolRange;
            }
        }
    });
}

function checkCollisions() {
    if (!ctx || (player.health <= 0 && !gameRunning)) return;

    for (let i = projectiles.length - 1; i >= 0; i--) {
        const p = projectiles[i];
        for (let j = enemies.length - 1; j >= 0; j--) {
            const enemy = enemies[j];
            if (enemy.alive &&
                p.x - p.radius < enemy.x + enemy.width &&
                p.x + p.radius > enemy.x &&
                p.y - p.radius < enemy.y + enemy.height &&
                p.y + p.radius > enemy.y) {
                enemy.alive = false;
                projectiles.splice(i, 1);
                score += 10;
                console.log("Ï†Å Î™ÖÏ§ë! ÌòÑÏû¨ Ï†êÏàò:", score);
                break;
            }
        }
    }

    if (!player.isInvincible) {
        enemies.forEach(enemy => {
            if (enemy.alive &&
                player.x < enemy.x + enemy.width &&
                player.x + player.width > enemy.x &&
                player.y < enemy.y + enemy.height &&
                player.y + player.height > enemy.y) {
                player.health--;
                player.isInvincible = true;
                player.lastHitTime = Date.now();
                console.log("ÌîåÎ†àÏù¥Ïñ¥ ÌîºÍ≤©! ÌòÑÏû¨ Ï≤¥Î†•:", player.health, "Î¨¥Ï†Å ÏÉÅÌÉú ÏãúÏûë");

                if (player.health > 0) {
                     player.x = 100;
                     player.y = canvas.height - 70;
                     player.dy = 0;
                     player.isGrounded = true;
                } else {
                    console.log("ÌîåÎ†àÏù¥Ïñ¥ Ï≤¥Î†• 0. Í≤åÏûÑ Ïò§Î≤Ñ.");
                }
            }
        });
    }
}

function resetGame() {
    if (!ctx) {
        console.error("resetGame Ìò∏Ï∂úÎêòÏóàÏúºÎÇò ctxÍ∞Ä ÏóÜÏñ¥ Ïã§Ìñâ Î∂àÍ∞Ä");
        return;
    }
    console.log("Í≤åÏûÑ Î¶¨ÏÖã ÏãúÏûë");
    player.x = 100;
    player.y = canvas.height - 70;
    player.dx = 0;
    player.dy = 0;
    player.health = player.maxHealth;
    player.isGrounded = false;
    player.isInvincible = false;
    player.facingDirection = 'right';
    player.lastAttackTime = 0;
    player.lastHitTime = 0;

    projectiles.length = 0;

    enemies.forEach(enemy => { // Ï†Å Ï†ïÎ≥¥ Ï¥àÍ∏∞Ìôî
        enemy.alive = true;
        enemy.x = enemy.originalX;
        // y ÏúÑÏπòÎèÑ ÌîåÎû´Ìèº Í∏∞Ï§ÄÏúºÎ°ú Ïû¨ÏÑ§Ï†ï
        const platformIndex = enemies.indexOf(enemy); // ÏûÑÏãúÎ°ú Ïù∏Îç±Ïä§ ÏÇ¨Ïö©, Îçî Ï¢ãÏùÄ Î∞©Î≤ïÏùÄ Ï†Å Í∞ùÏ≤¥Ïóê ÌîåÎû´Ìèº Ï†ïÎ≥¥ Ï†ÄÏû•
        if (platformIndex === 0 && platforms[1]) enemy.y = platforms[1].y - enemy.height;
        else if (platformIndex === 1 && platforms[2]) enemy.y = platforms[2].y - enemy.height;
        else if (platformIndex === 2 && platforms[0]) enemy.y = platforms[0].y - enemy.height;

    });


    score = 0;
    gameRunning = true;
    console.log("Í≤åÏûÑ Î¶¨ÏÖã ÏôÑÎ£å. gameRunning:", gameRunning);
}

let gameRunning = true;
function gameLoop() {
    if (!ctx) { // ctxÍ∞Ä ÏóÜÏúºÎ©¥ Í≤åÏûÑ Î£®ÌîÑÎ•º Ïã§ÌñâÌï† Ïàò ÏóÜÏùå
        console.warn("gameLoop Ìò∏Ï∂úÎêòÏóàÏúºÎÇò ctxÍ∞Ä ÏóÜÏñ¥ Ï§ëÎã®Ìï©ÎãàÎã§.");
        return;
    }
    clearCanvas();

    if (gameRunning) {
        updatePlayer();
        updateProjectiles();
        updateEnemies();
        checkCollisions();

        if (player.health <= 0) {
            gameRunning = false;
            console.log("Í≤åÏûÑ Î£®ÌîÑ ÎÇ¥ÏóêÏÑú Í≤åÏûÑ Ïò§Î≤Ñ Í∞êÏßÄ. gameRunning:", gameRunning);
        }
    }

    drawPlatforms();
    drawEnemies();
    drawProjectiles();
    drawPlayer();
    drawUI();

    requestAnimationFrame(gameLoop);
}

// --- ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ---
function handleKeyDown(e) {
    if (e.code === 'ArrowLeft') keys.ArrowLeft = true;
    if (e.code === 'ArrowRight') keys.ArrowRight = true;
    if (e.code === 'Space') keys.Space = true;
    if (e.code === 'KeyA') keys.KeyA = true;

    if (!gameRunning && e.code === 'KeyR' && player.health <= 0) {
        resetGame();
    }
}

function handleKeyUp(e) {
    if (e.code === 'ArrowLeft') keys.ArrowLeft = false;
    if (e.code === 'ArrowRight') keys.ArrowRight = false;
    if (e.code === 'Space') keys.Space = false;
    if (e.code === 'KeyA') keys.KeyA = false;
}

document.addEventListener('keydown', handleKeyDown);
document.addEventListener('keyup', handleKeyUp); // Ïù¥Ï†Ñ ÏΩîÎìúÏùò Ïò§ÌÉÄ ÏàòÏ†ïÎê®

// --- Í≤åÏûÑ ÏãúÏûë Ï†Ñ Ï¥àÍ∏∞Ìôî ---
function initializeGameElements() {
    if (!ctx) {
        console.error("Í≤åÏûÑ ÏöîÏÜå Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ctxÍ∞Ä ÏóÜÏäµÎãàÎã§.");
        return;
    }
    // Ï†Å y ÏúÑÏπò Ï¥àÍ∏∞Ìôî (platforms Î∞∞Ïó¥Ïù¥ Ï†ïÏùòÎêú ÌõÑÏóê)
    // enemies Î∞∞Ïó¥ÏùÑ Ïó¨Í∏∞ÏÑú Îã§Ïãú Ï†ïÏùòÌïòÍ±∞ÎÇò, y Í∞íÎßå ÏóÖÎç∞Ïù¥Ìä∏
    enemies.length = 0; // Í∏∞Ï°¥ Ï†Å Î∞∞Ïó¥ ÎπÑÏö∞Í∏∞
    enemies.push(
        { x: 200, y: platforms[1].y - 30, width: 30, height: 30, color: '#C0392B', alive: true, speed: 0.7, direction: 1, originalX: 200, patrolRange: 60 },
        { x: 450, y: platforms[2].y - 30, width: 30, height: 30, color: '#C0392B', alive: true, speed: 0, direction: 1, originalX: 450, patrolRange: 0 },
        { x: 650, y: platforms[0].y - 30, width: 30, height: 30, color: '#C0392B', alive: true, speed: 1, direction: -1, originalX: 650, patrolRange: 80 }
    );
    console.log("Ï†Å y ÏúÑÏπò Î∞è Î∞∞Ïó¥ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å. Ï≤´ Î≤àÏß∏ Ï†Å y:", enemies[0] ? enemies[0].y : "ÏóÜÏùå");
}


// --- Í≤åÏûÑ ÏãúÏûë ---
if (ctx) { // ctxÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÎêòÏóàÏùÑ ÎïåÎßå Í≤åÏûÑ ÏãúÏûë
    initializeGameElements();
    console.log("Í≤åÏûÑ Î£®ÌîÑ ÏãúÏûë ÏßÅÏ†Ñ");
    gameLoop();
    console.log("Ï≤´ Í≤åÏûÑ Î£®ÌîÑ Ìò∏Ï∂úÎê®");
} else {
    console.error("ctxÍ∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏïÑ Í≤åÏûÑÏùÑ ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
}
